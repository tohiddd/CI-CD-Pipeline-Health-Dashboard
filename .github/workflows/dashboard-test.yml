name: ğŸš€ CI/CD Dashboard Build & Test

on:
  # Trigger manually from GitHub Actions tab
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'Test scenario to run'
        required: true
        default: 'success'
        type: choice
        options:
          - success
          - failure
          - long_running
  
  # Trigger on push to main branch
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  
  # Trigger on pull requests
  pull_request:
    branches: [ main, master ]

jobs:
  dashboard-test:
    name: ğŸš€ Dashboard Pipeline Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'backend/package-lock.json'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        cd backend
        npm ci
        
    - name: ğŸ§ª Run Tests
      run: |
        echo "ğŸ§ª Running CI/CD Dashboard tests..."
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
        echo "Workflow: ${{ github.workflow }}"
        
        # Validate essential dashboard files exist
        echo "ğŸ” Checking dashboard structure..."
        
        if [ -f "backend/package.json" ] && [ -f "frontend/package.json" ]; then
          echo "âœ… Dashboard structure is valid"
        else
          echo "âŒ Missing essential dashboard files"
          exit 1
        fi
        
        # Test backend dependencies
        echo "ğŸ”§ Validating backend configuration..."
        if [ -f "backend/server.js" ]; then
          echo "âœ… Backend server found"
        else
          echo "âŒ Backend server missing"
          exit 1
        fi
        
    - name: ğŸ“Š Test Scenario Handler
      run: |
        SCENARIO="${{ github.event.inputs.test_scenario || 'success' }}"
        echo "ğŸ¯ Running test scenario: $SCENARIO"
        
        case $SCENARIO in
          "success")
            echo "âœ… Success scenario - All tests passed!"
            echo "This will show as a successful pipeline in your dashboard"
            exit 0
            ;;
          "failure")
            echo "âŒ Failure scenario - Simulating test failure"
            echo "This will trigger failure alerts in your dashboard"
            echo "Testing alert notifications..."
            exit 1
            ;;
          "long_running")
            echo "â³ Long running scenario - Simulating slow build"
            echo "This will test build duration metrics"
            for i in {1..30}; do
              echo "Processing step $i/30..."
              sleep 2
            done
            echo "âœ… Long running test completed!"
            ;;
          *)
            echo "âœ… Default success case"
            ;;
        esac
        
    - name: ğŸ¨ Generate Test Artifact
      if: always()
      run: |
        mkdir -p test-results
        cat > test-results/dashboard-test-report.txt << EOF
        ğŸ§ª CI/CD Dashboard Test Report
        ==============================
        
        Repository: ${{ github.repository }}
        Workflow: ${{ github.workflow }}
        Run ID: ${{ github.run_id }}
        Branch: ${{ github.ref_name }}
        Commit: ${{ github.sha }}
        Author: ${{ github.actor }}
        Timestamp: $(date)
        Scenario: ${{ github.event.inputs.test_scenario || 'auto-trigger' }}
        
        Status: $(if [ "${{ job.status }}" = "success" ]; then echo "âœ… SUCCESS"; else echo "âŒ FAILED"; fi)
        
        This pipeline run should appear in your CI/CD Dashboard at:
        http://localhost:3000
        
        Expected Dashboard Features:
        - Pipeline status and metrics
        - Build duration tracking  
        - Success/failure rates
        - Commit and author information
        - Real-time updates via WebSocket
        EOF
        
    - name: ğŸ“¤ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dashboard-test-results-${{ github.run_id }}
        path: test-results/
        retention-days: 7
        
  notification-test:
    name: ğŸ“± Test Dashboard Detection
    runs-on: ubuntu-latest
    needs: dashboard-test
    if: always()
    
    steps:
    - name: ğŸ“Š Pipeline Summary
      run: |
        echo "ğŸ¯ CI/CD Dashboard Pipeline Test Summary"
        echo "========================================"
        echo ""
        echo "âœ… Pipeline executed successfully"
        echo "ğŸ“Š Status: ${{ needs.dashboard-test.result }}"
        echo "ğŸ”„ This run should now be visible in your dashboard"
        echo ""
        echo "ğŸŒ Check your dashboard at: http://localhost:3000"
        echo "ğŸ” Look for:"
        echo "  â€¢ New pipeline run entry"
        echo "  â€¢ Updated success/failure metrics"  
        echo "  â€¢ Build duration information"
        echo "  â€¢ Real-time status updates"
        echo ""
        if [ "${{ needs.dashboard-test.result }}" = "failure" ]; then
          echo "ğŸš¨ This was a failure test - check for alert notifications!"
        else
          echo "âœ… This was a successful test run"
        fi
